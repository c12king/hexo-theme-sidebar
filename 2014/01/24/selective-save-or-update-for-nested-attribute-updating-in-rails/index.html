<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>selective save or update for nested attribute updating in rails | Hexo</title>
  <meta name="author" content="John Doe">
  
  <meta name="description" content="For associated models, Mongoid proves a nested attributes option to allow you to save attributes on associated records through the parent 
accepts_nes">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0>

  <meta property="og:title" content="selective save or update for nested attribute updating in rails"/>
  <meta property="og:site_name" content="Hexo"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link rel="stylesheet" href="/hexo-theme-sidebar/css/bootstrap.min.css" type="text/css">
  <link rel="stylesheet" href="/hexo-theme-sidebar/css/simple-sidebar.css" type="text/css">
  <link href="/hexo-theme-sidebar/favicon.png" rel="icon">
  <link rel="alternate" href="/hexo-theme-sidebar/atom.xml" title="Hexo" type="application/atom+xml">
  <!-- <link rel="stylesheet" href="/hexo-theme-sidebar/css/style.css" media="screen" type="text/css"> -->
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  
</head>

<body>

<div id="wrapper">

  <!-- Sidebar -->
  <div id="sidebar-wrapper">
    <ul class="sidebar-nav nav text-center">
      <li>
  <div>
    <a href="/hexo-theme-sidebar/">
      <img class="img-circle" src="/hexo-theme-sidebar/img/sword.gif" alt="Anthem" height="180" width="180">
    </a>
  </div>
</li>
<li>
  <a href="/hexo-theme-sidebar/">Hexo</a>
</li>




  <li><a href="/hexo-theme-sidebar//archives">Blog</a></li>

  <li><a href="/hexo-theme-sidebar//projects">Projects</a></li>

  <li><a href="/hexo-theme-sidebar//notes">Notes</a></li>

  <li><a href="/hexo-theme-sidebar//about">About</a></li>

    </ul>

    <div class="text-center">
    
  <p><form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><input type="hidden" name="q" value="site:http://wuinm.com/hexo-theme-sidebar"></form>
 </p>

  <p> </p>

  <p>
    <!-- <lead class="title text-center">Tags</lead> -->
    
      <a href="/hexo-theme-sidebar/tags/CS/">CS
      <span class="badge"> 2 </span></a>
    
      <a href="/hexo-theme-sidebar/tags/General/">General
      <span class="badge"> 1 </span></a>
    
      <a href="/hexo-theme-sidebar/tags/Physics/">Physics
      <span class="badge"> 2 </span></a>
    
 </p>



    
  
  &copy; 2014 John Doe
  

    </div>
  </div>

  <!-- Page content -->
  <div id="page-content-wrapper">
    <button id="menu-toggle" href="#" class="btn btn-default ">
      <span class="glyphicon glyphicon glyphicon-tasks" ></span>
    </button>

    


    <div class="content-header ">
      
        <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
      
      
  
    <h1 class="title">selective save or update for nested attribute updating in rails</h1>
  

    </div>
    <div class="entry page-content inset ">
      
        <time datetime="2014-01-24T05:00:00.000Z"><a href="/hexo-theme-sidebar/2014/01/24/selective-save-or-update-for-nested-attribute-updating-in-rails/">Jan 24 2014</a></time>
        <div class="icon"></div>
       <br />

      
        <p>For associated models, Mongoid proves a nested attributes option to allow you to save attributes on associated records through the parent </p>
<pre><code>accepts_nested_attributes_for :entry_names, allow_destroy: true
</code></pre><p>It works well for 1-1 relation. But in 1-n and n-n relations, one may find it problematic.The child documents often duplicates with existing ones. </p>
<p>In a simple case, there is a parent model <em>Entry</em> with HABTM relation to its child <em>EntryName</em>. Each <strong>EntryName</strong> has only one attribute <strong>content</strong>. Many <em>entry_names</em> created by different <em>entries</em>, but with the same <code>@entry_name.content</code>, would be unnecessary and hard to show the <em>entry_names</em> to users. The user may get multiple <em>EntryName</em> instances in a single search action with a single content value. The optimal solution is that an existing <em>entry_name</em> will be associate to the <em>entry</em> upon saving this <em>entry</em> if it is found with </p>
<pre><code>EntryName.find_by(content: name.content)
</code></pre><p>Otherwise, a new <em>entry_name</em> can be safely created and associated to the <em>entry</em>.</p>
<p>The trick is using the <code>before_add</code> callback to the parent model. </p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="code"><pre><span class="class"><span class="keyword">class</span> <span class="title">Entry</span></span>
  <span class="keyword">include</span> <span class="constant">Mongoid::Document</span>
  <span class="comment"># ...</span>
  <span class="comment"># ...</span>

  has_and_belongs_to_many <span class="symbol">:entry_names</span>, <span class="symbol">dependent:</span> <span class="symbol">:destroy</span>, <span class="symbol">before_add:</span> <span class="symbol">:replace_by_</span> existing_name
  
  protected

  <span class="function"><span class="keyword">def</span> </span>replace_by_existing_name(name)
    <span class="keyword">if</span> name.new_record?
      <span class="keyword">begin</span>
        <span class="keyword">if</span> <span class="variable">@existing</span> = <span class="constant">EntryName</span>.find_by(<span class="symbol">content:</span> name.content)
          name.id = <span class="variable">@existing</span>.id
          name.new_record = <span class="keyword">false</span>          
        <span class="keyword">end</span>
        <span class="keyword">return</span> <span class="keyword">true</span>  
      <span class="keyword">rescue</span>  
        <span class="keyword">return</span> <span class="keyword">true</span>
      <span class="keyword">end</span>      
    <span class="keyword">end</span>
  <span class="keyword">end</span> 
<span class="keyword">end</span>
</pre></td></tr></table></figure>



      
      <footer>
        
          
          
  
  <div class="tags">
    <p>Tags:
    <a href="/hexo-theme-sidebar/tags/CS/">CS</a>
    </p>
  </div>

          
  <div class="addthis addthis_toolbox addthis_default_style">
    
      <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
    
    
      <a class="addthis_button_tweet"></a>
    
    
      <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
    
    
      <a class="addthis_button_pinterest_pinit" pi:pinit:layout="horizontal"></a>
    
    <a class="addthis_counter addthis_pill_style"></a>
  </div>
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js"></script>

        

        <div class="clearfix"></div>
      </footer>


      
<section id="comment">
  <!-- <h1 class="title">Comments</h1> -->

  
</section>


    </div>






  </div>

  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/hexo-theme-sidebar/js/jquery.imagesloaded.min.js"></script>
<script src="/hexo-theme-sidebar/js/gallery.js"></script>
<script type="text/javascript" src="/hexo-theme-sidebar/js/bootstrap.min.js"></script>

<!-- Custom JavaScript for the Menu Toggle -->
<script>
$("#menu-toggle").click(function(e) {
    e.preventDefault();
    $("#wrapper").toggleClass("active");
});
</script>




<link rel="stylesheet" href="/hexo-theme-sidebar/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/hexo-theme-sidebar/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>


<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  TeX: {
    equationNumbers: {
      autoNumber: "AMS"
    },
  },
  tex2jax: {
    inlineMath: [
      ['$', '$'],
      ["\\(", "\\)"]
    ],
    displayMath: [
      ['$$', '$$'],
      ["\\[", "\\]"]
    ],
    processEscapes: true
  },
  "HTML-CSS": {
    linebreaks: {
      automatic: true
    }
  },
  SVG: {
    linebreaks: {
      automatic: true
    }
  }
});
</script>


<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
</div>

</body>
</html>